---
title: "Capstone Difference in Difference Report"
author: "Cindy Elder, Max Bi and Gabby Lopez"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(zoo) # to extract month out of the standard date format
library(rstudioapi) # to allow us to use file.path 
library(did) # package from other professors who require time change in start
library(geepack) #geeglm
library(knitr)

knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
# ! Do we have to run the models in here to get the printouts? 




fp_visits = file.path(getwd(), "Analysis Data/all_visit_types.csv")
all_visit_types <- read.csv(fp_visits) 
# Mark Visit Types with Marshallese and NHW
# all_visit_types  has M indicator from previous DataCleaningDID.R script, which shows 
# 1 = marshallese, 0 = Non-Hispanic White, NA = Other not in our analysis)


# start building dataframe
did_visit_types_qtr <- all_visit_types %>% filter(Date >= "2019-06-01", Date <= "2019-08-31"  | # pretreat
                                                Date >= "2022-06-01", Date <= "2022-08-31") # post treat
# remove the NA, not our target pop
did_visit_types_qtr <- did_visit_types_qtr %>% filter(!is.na(marsh)) 
did_visit_types_qtr <- did_visit_types_qtr %>% mutate(year_center = (year - 2019) )

did_visit_types_qtr <- did_visit_types_qtr %>% mutate(ER = if_else(ServiceLine == "Emergency", 1, 0), 
                                              PCP = if_else(ServiceLine == "Primary Care", 1, 0))








did_visit_types_qtr_2019 <- did_visit_types_qtr %>% filter(year == 2019)
did_visit_types_qtr_2022 <- did_visit_types_qtr %>% filter(year == 2022)

UID_balanced_panel_year <- intersect(did_visit_types_qtr_2019$UniqueIdentifier, did_visit_types_qtr_2022$UniqueIdentifier)

did_visit_types_qtr_balanced <- did_visit_types_qtr %>% filter(UniqueIdentifier %in% UID_balanced_panel_year)







# Change to year 
did_visit_types_year <- all_visit_types %>% filter(Date >= "2018-08-31", Date <= "2019-08-31"  | # pretreat
                                                Date >= "2021-08-31", Date <= "2022-08-31") # post treat

# start_date = "2018-08-31", end_date = "2019-08-31") # All service lines = total population
# 
# start_date = "2021-08-31", end_date = "2022-08-31") # All service lines = total population


# remove the NA, not our target pop
did_visit_types_year <- did_visit_types_year %>% filter(!is.na(marsh)) 
# removed 1/3 of visits not our target pop




did_visit_types_year <- did_visit_types_year %>% mutate(ER = if_else( ((ServiceLine == "Emergency") &
                                                                    (Date >= "2019-06-01" & Date <= "2019-08-31" |
                                                                       Date >= "2022-06-01" & Date <= "2022-08-31" ) ), 1, 0),
                                              PCP = if_else( ( ( ServiceLine == "Primary Care") &
                                                                 (Date >= "2019-06-01" & Date <= "2019-08-31" |
                                                                    Date >= "2022-06-01"& Date <= "2022-08-31" ) ), 1, 0))


did_visit_types_year <- did_visit_types_year %>% mutate(year_center = (year - 2019) )

did_visit_types_year_2019 <- did_visit_types_year %>% filter(year == 2019)
did_visit_types_year_2022 <- did_visit_types_year %>% filter(year == 2022)

UID_balanced_panel_year <- intersect(did_visit_types_year_2019$UniqueIdentifier, did_visit_types_year_2022$UniqueIdentifier)

did_visit_types_year_balanced <- did_visit_types_year %>% filter(UniqueIdentifier %in% UID_balanced_panel_year)




gee_mod_DID_ER_yr <- geeglm(ER ~ marsh*year_center, 
                         data = did_visit_types_year,
                         id = UniqueIdentifier,
                         family = gaussian, 
                         scale.fix = T, # this sets phi = 1
                         corstr = "exchangeable")
gee_mod_DID_PCP_yr <- geeglm(PCP ~ marsh*year_center, 
                          data = did_visit_types_year,
                          id = UniqueIdentifier,
                          family = gaussian, 
                          scale.fix = T, # this sets phi = 1
                          corstr = "exchangeable")

gee_mod_DID_ER_yr_bal <- geeglm(ER ~ marsh*year_center, 
                             data = did_visit_types_year_balanced,
                             id = UniqueIdentifier,
                             family = gaussian, 
                             scale.fix = T, # this sets phi = 1
                             corstr = "exchangeable")


gee_mod_DID_PCP_yr_bal <- geeglm(PCP ~ marsh*year_center, 
                              data = did_visit_types_year_balanced,
                              id = UniqueIdentifier,
                              family = gaussian, 
                              scale.fix = T, # this sets phi = 1
                              corstr = "exchangeable")


gee_mod_DID_PCP_qtr <- geeglm(PCP ~ marsh*year_center, 
                          data = did_visit_types_qtr,
                          id = UniqueIdentifier,
                          family = gaussian, # previously I used in longitudinal class family=binomial(link="logit"),
                          # waves = time, # we only have one wave of treatment
                          scale.fix = T, # this sets phi = 1
                          corstr = "exchangeable")
gee_mod_DID_ER_qtr <- geeglm(ER ~ marsh*year_center, 
                         data = did_visit_types_qtr,
                         id = UniqueIdentifier,
                         family = gaussian, # previously I used in longitudinal class family=binomial(link="logit"),
                         # waves = time, # we only have one wave of treatment
                         scale.fix = T, # this sets phi = 1
                         corstr = "exchangeable")
gee_mod_DID_ER_qtr_bal <- geeglm(ER ~ marsh*year_center, 
                         data = did_visit_types_qtr_balanced,
                         id = UniqueIdentifier,
                         family = gaussian, # previously I used in longitudinal class family=binomial(link="logit"),
                         # waves = time, # we only have one wave of treatment
                         scale.fix = T, # this sets phi = 1
                         corstr = "exchangeable")

gee_mod_DID_PCP_qtr_bal <- geeglm(PCP ~ marsh*year_center, 
                          data = did_visit_types_qtr_balanced,
                          id = UniqueIdentifier,
                          family = gaussian, # previously I used in longitudinal class family=binomial(link="logit"),
                          # waves = time, # we only have one wave of treatment
                          scale.fix = T, # this sets phi = 1
                          corstr = "exchangeable")


```

# For ER Rates Population per Year

## All Patients in 2019 to 2022

Since the first Marshallese Community Health Worker (CHW) was hired in September 2019, we used the period of August 31, 2018 to August 31, 2019 as the pre-treatment populations of Marshallese and Non-Hispanic White patients at the Maple and Market clinics. We also used the same dates in 2021 and 2022 to find the post-treatment populations.

! Size of population

The population of CHAS patients has grown over time. Using data from all of the patients who visited the CHAS Maple and Market clinics during this time, we built a model that accounts for the correlation that results from patients who have been there in both 2019 and 2022, and includes patients who were not there in 2019 but joined by 2022. 

We modeled the number of ER visits between June 1 and August 31, 2019, and the number for the same dates in 2022, using a saturated model with indicators for Marshallese, year, and the interaction of these 2 variables.

Using GEE GLM, we estimate that the expected value of ER visits per patients for our control population of  Non-Hispanic White patients in 2019 is `r gee_mod_DID_ER_yr$coefficients[1]`.

Similarly, we estimate the rate of ER visits per person visits for Marshallese in 2019 is `r gee_mod_DID_ER_yr$coefficients[1] + gee_mod_DID_ER_yr$coefficients[2]`. This is slightly higher than the Non-Hispanic White population, but we note that the p-value is above the alpha = 0.05 level (p-value = 0.063.)

! how to take out the p-value of this model? 



Over the next three years, the rate of change for the ER visits Non-Hispanic White patients went up by `r gee_mod_DID_ER_yr$coefficients[3]` per year.  __ trend. This may not be not be surprising since this data was recorded during the COVID pandemic. However, we note that the rate of change for the Marshallese patients went up by a smaller amount during the same time, `r gee_mod_DID_ER_yr$coefficients[3] + gee_mod_DID_ER_yr$coefficients[4]` per year. The p-values for these coefficients are both significant at less than 0.001. 

Based on the Difference in Difference causal model, we interpret lower rate of ER visits for the Marshallese as the effect of the Marshallese Healthcare Workers. 

__ trend

! we can use causal language with DID.
! do we like our interpretations? Should I calculate the slope *3 for the 3 year change? 


## Existing Patients from 2019

When we restrict the analysis to patients that were there the entire time period, from 2019 to 2022, we see similar trends. 

! how do we pull out knitr tables with this model?




# ER Rates Population per Quarter
We also analyzed the model using only patients who visited the CHAS Maple and Market Clinics in the same quarter.  


Pop size shrank by 25% for the Non-Hispanic White population, and about 33% for the Marshallese population. 
```{r}
 315/476
# 0.662
 13804/18586
# 0.743

```


```{r}

summary(gee_mod_DID_PCP_yr)
summary(gee_mod_DID_PCP_yr_bal)

summary(gee_mod_DID_PCP_qtr)
summary(gee_mod_DID_PCP_qtr_bal)

summary(gee_mod_DID_ER_yr)
summary(gee_mod_DID_ER_yr_bal)

summary(gee_mod_DID_ER_qtr)
summary(gee_mod_DID_ER_qtr_bal)



#knitr::kable(twobytwo, caption = "Contingency table of whether patient achieved complete remission by treatment group.")
```



# Primary Care Provider Visits

!
