---
title: "Capstone EDA"
author: "Gabby Lopez"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(gtsummary)
library(lubridate)
library(naniar)
library(flextable)
```

# Descriptive Statistics

```{r cars, include=FALSE, echo=FALSE}
a1c <- read.csv("Raw Data/UWDataA1cs.csv")
bmi <- read.csv("Raw Data/UWDataBMIs.csv")
bp <- read.csv("Raw Data/UWDataBP.csv")
diag <- read.csv("Raw Data/UWDataDiagnoses.csv")
enc <- read.csv("Raw Data/UWDataEncounters.csv")
panel <- read.csv("Raw Data/UWDataPanel.csv")
koh.attend <- read.csv("Raw Data/UWDataKOHAttendance.csv")
```

There are 673 patients that are marked as having prediabetes as well as type II diabetes. Not a big deal for the actual analysis itself since we will combine these two indicator variables into one variable, but we should clear this up for our descriptive statistics.
```{r, include=FALSE, echo=FALSE}
pre.t2dm <- diag %>% filter(PreDM == 1 & T2DM == 1)
```

```{r, include=FALSE, echo=FALSE}
# change date variable to date type and remove NA values in necessary fields
a1c$Date <- mdy(a1c$Date)
a1c.nona <- a1c %>% filter(!is.na(A1c) & !is.na(Date))

bmi$Date <- mdy(bmi$Date)
bmi.nona <- bmi %>% filter(!is.na(Date) & !is.na(BMI))

bp$Date <- mdy(bp$Date)
bp.nona <- bp %>% filter(!is.na(Date) & !is.na(Systolic))

enc$Date <- mdy(enc$Date)
enc.nona <- enc %>% filter(!is.na(Date) & !is.na(ServiceLine))

koh.attend$Date <- mdy(koh.attend$dateAttended)
koh.attend <- koh.attend %>% filter(!is.na(Date))
koh.counts <- koh.attend %>% group_by(UniqueIdentifier) %>% count(name = "koh.counts")

diag.nona <- diag %>% filter(!is.na(HTN) & !is.na(PreDM) & !is.na(T2DM))
# create diabetes indicator for both pre and T2DM and indicator for if they have both htn and diabetes
diag.nona <- diag.nona %>% mutate(Diabetes = ifelse((PreDM == 1 | T2DM == 1), 1, 0),
                                  both = ifelse((Diabetes == 1 & HTN == 1), 1, 0))
```

```{r, include=FALSE, echo=FALSE}
# Remove anyone under the age of 18
age <- panel %>% select(c("UniqueIdentifier","age"))
a1c.nona.18 <- left_join(a1c.nona, age, by = "UniqueIdentifier")
a1c.nona.18 <- a1c.nona.18 %>% filter(age >= 18)

bmi.nona.18 <- left_join(bmi.nona, age, by = "UniqueIdentifier")
bmi.nona.18 <- bmi.nona.18 %>% filter(age >= 18)

bp.nona.18 <- left_join(bp.nona, age, by = "UniqueIdentifier")
bp.nona.18 <- bp.nona.18 %>% filter(age >= 18)

enc.nona.18 <- left_join(enc.nona, age, by = "UniqueIdentifier")
enc.nona.18 <- enc.nona.18 %>% filter(age >= 18)

diag.nona.18 <- left_join(diag.nona, age, by = "UniqueIdentifier")
diag.nona.18 <- diag.nona.18 %>% filter(age >= 18)

koh.attend.18 <- left_join(koh.attend, age, by = "UniqueIdentifier")
koh.attend.18 <- koh.attend.18 %>% filter(age >= 18)

# patients with KOHParticipant = 1 but are not in KOH attendance dataset
panel.koh <- panel %>% filter(KOHParticipant == 1 & age>=18)
k <- full_join(koh.counts, panel.koh, by = "UniqueIdentifier")
k %>% filter(is.na(koh.counts))

panel <- panel %>% mutate(Sex.long = case_when(Sex == 'M' ~ 'Male',
                                               Sex == 'F' ~ 'Female'))
panel.18 <- panel %>% filter(age >= 18)

# just checking the possible races
unique(panel.18$Race)
marsh <- panel.18 %>% filter(Race == 'Marshallese')
lang <- panel.18 %>% filter(Language == 'Marshallese')
#there are a lot of patients with Race = Marshallese that don't have language Marshallese and vice versa

# create our population of non-hispanic whites and marshallese (language = marsh or race = marsh or KOH = 1) - think there might be a KOH participant that doesn't have race or language as marshallese but I need to double check
targetpop <- panel.18 %>% filter(Race == 'Marshallese' | Language == 'Marshallese' | KOHParticipant == 1 | (Race == 'White' & Ethnicity == 'Not Hispanic or Latino'))

# make marshallese indicator variable
targetpop <- targetpop %>% mutate(Marsh = ifelse((Race == 'White' & Ethnicity == 'Not Hispanic or Latino'), 0, 1),
                                  Group = ifelse(Marsh == 1, "Marshallese", "Non-Marshallese"))
```

```{r include=FALSE}
# Prep for table 1
unique(targetpop$No.column.name)
targetpop$No.column.name <- factor(targetpop$No.column.name, 
                                   levels = c('Housed','Doubling Up','Permanent Supportive Housing','Transitional','Homeless Shelter',
                                              'Street','Other','Unknown'))

typeof(targetpop$Language)
unique(targetpop$ClinicLocation)

# replace all the blanks in the character variables with NAs so we can count the missings in the table
targetpop <- targetpop %>% replace_with_na_all(condition = ~.x == "")

# get rid of the age variable we got from merging to filter out children since targetpop already has age
diag.nona.18 <- diag.nona.18 %>% select(-age)

# merge diagnosis data with other characteristics
table1 <- right_join(diag.nona.18, targetpop, by = "UniqueIdentifier")

# create subset of only KOH participants
koh <- table1 %>% filter(KOHParticipant == 1)
koh.table1 <- full_join(koh.counts, koh, by = "UniqueIdentifier")
```

table 1 for KOH only - need to add average number of KOH meetings attended
```{r echo=FALSE, warning=FALSE}
koh.table1 %>% select(c('age','Sex.long','koh.counts','HTN','Diabetes','both','ClinicLocation','No.column.name','IncomeLevel','BLACERISK')) %>%
   gtsummary::tbl_summary(
     by = NULL,
     include = c(age, Sex.long, koh.counts, HTN, Diabetes, both, ClinicLocation, No.column.name, IncomeLevel, BLACERISK),
     label = list(
       age ~ 'Age',
       Sex.long ~ 'Sex',
       koh.counts ~ 'KOH Meetings Attended',
       HTN ~ 'Hypertension',
       Diabetes ~ 'Pre-Diabetes or T2DM',
       both ~ 'Hypertension and T2DM',
       ClinicLocation ~ 'Clinic Location',
       No.column.name ~ 'Housing Status',
       IncomeLevel ~ 'Income Level',
       BLACERISK ~ 'Risk Score'
     ),
     missing_text = "Missing",
     type = all_continuous() ~ "continuous2",
     statistic = all_continuous() ~ c(
       "{median} ({min}, {max})"
     )
   )  %>%
   bold_labels() %>%
   modify_footnote(c(all_stat_cols()) ~ NA) %>%
   modify_header(label ~ "**Baseline Characteristics**") %>%
  modify_header(all_stat_cols() ~ "**KOH Participants**<br>\nN = {n}") %>%
   as_flex_table()
```
distribution of KOH attendance
```{r}
hist(koh.table1$koh.counts)
summary(koh.table1$koh.counts)
summary(as.factor(koh.table1$koh.counts))
```

subsetting koh patients with hypertension
```{r}
# get pts with htn
koh.htn <- koh.table1 %>% filter(HTN == 1)
# isolate the patient ids
koh.htn.patlist <- koh.htn %>% select("UniqueIdentifier")
# select bp measures for only kohn htn pts
koh.bp <- left_join(koh.htn.patlist, bp.nona.18, by = "UniqueIdentifier") %>% select(-age)

# count number of bp readings per patient
koh.bp.counts <- koh.bp %>% group_by(UniqueIdentifier) %>% count(name = "bp.counts")
# remove any patients that only have 1 reading - i will filter out any that don't have reading before and after their KOH meeting but for now, we at least know they need to have at least 2 bp readings
koh.htn.elig.patlist <- koh.bp.counts %>% filter(bp.counts > 1) %>% select("UniqueIdentifier")
# now that we have the "eligible patients" we can subset the BP data for these patients
koh.bp.elig <- left_join(koh.htn.elig.patlist, koh.bp, by = "UniqueIdentifier")
```

subsetting koh patients with prediabetes or T2DM
```{r}
# get pts with diabetes
koh.t2dm <- koh.table1 %>% filter(Diabetes == 1)
# isolate the patient ids
koh.t2dm.patlist <- koh.t2dm %>% select("UniqueIdentifier")
# select a1c measures for only koh t2dm pts
koh.a1c <- left_join(koh.t2dm.patlist, a1c.nona.18, by = "UniqueIdentifier") %>% select(-age)

# count number of a1c readings per patient
koh.a1c.counts <- koh.a1c %>% group_by(UniqueIdentifier) %>% count(name = "a1c.counts")
# remove any patients that only have 1 reading - i will filter out any that don't have reading before and after their KOH meeting but for now, we at least know they need to have at least 2 a1c readings
koh.t2dm.elig.patlist <- koh.a1c.counts %>% filter(a1c.counts > 1) %>% select("UniqueIdentifier")
# now that we have the "eligible patients" we can subset the a1c data for these patients
koh.a1c.elig <- left_join(koh.t2dm.elig.patlist, koh.a1c, by = "UniqueIdentifier")
```


table 1 for all Marshallese and non-Marshallese
```{r echo=FALSE, warning=FALSE}
table1 %>% select(c('Group','age','Sex.long','HTN','Diabetes','both','ClinicLocation','No.column.name','IncomeLevel','BLACERISK')) %>%
   gtsummary::tbl_summary(
     by = Group,
     include=c(age, Sex.long, HTN, Diabetes, both, ClinicLocation, No.column.name, IncomeLevel, BLACERISK),
     list(
       age ~ 'Age',
       Sex.long ~ 'Sex',
       HTN ~ 'Hypertension',
       Diabetes ~ 'Pre-Diabetes or T2DM',
       both ~ 'Hypertension and T2DM',
       ClinicLocation ~ 'Clinic Location',
       No.column.name ~ 'Housing Status',
       IncomeLevel ~ 'Income Level',
       BLACERISK ~ 'Risk Score'
     ),
     missing_text = "Missing",
     type = all_continuous() ~ "continuous2",
     statistic = all_continuous() ~ c(
       "{median} ({min}, {max})"
     )
   ) %>%
   bold_labels() %>%
   modify_footnote(c(all_stat_cols()) ~ NA) %>%
   modify_header(label ~ "**Baseline Characteristics**") %>%
   modify_header(all_stat_cols() ~ "**{level}**<br>\nN = {n}") %>%
   add_overall() %>%
   as_flex_table()
```

# KOH Attendance Distribution

```{r}
koh_1x = koh.counts %>% filter(koh.counts == 1)
koh_1x = koh_1x %>% 
  left_join(koh.attend.18, by="UniqueIdentifier") %>% 
  select(Date)
koh_1x = koh_1x %>% 
  group_by(Date) %>% 
  summarize(attendees=n(), .groups="drop")

ggplot(koh_1x, aes(x=Date, y=attendees)) +
  geom_col(fill="steelblue") +
  geom_text(aes(label=Date, angle=90, vjust=-0.5)) +
  labs(title="Number of KOH Attendees by Date",
       x="KOH Meeting Date",
       y="Number of Attendees")
```


# Preliminary Parallel Trends EDA

```{r}
# join encounter and panel data to get visit types by race
enc_wraces = enc.nona.18 %>% 
  left_join(panel.18, by="UniqueIdentifier") %>% 
  select(Date, ServiceLine, Race, Language)

# dates up to March 2023 are of interest, also t_0 to new yr's day 2021
tot_months = 26
t_0 = enc_wraces$Date %>% min() - days(8)

# initialize empty dataframe to store monthly PC visit counts
pc_trends = tibble(
  visits = numeric(),
  race = character(),
  Date = Date()
)

# iterate through all months and count PC visits
curr_date = t_0
for (i in 1:tot_months) {
  # filter for only PC visits
  curr_pc_visits = enc_wraces %>% filter(
    month(Date) == month(curr_date) &
    year(Date) == year(curr_date) & 
    ServiceLine == "Primary Care"
  )
  
  # filter for/add visits by Marshallese
  curr_marsh_visits = curr_pc_visits %>% filter(
    Race == "Marshallese" |
    Language == "Marshallese"
  ) %>% count()
  
  pc_trends = pc_trends %>% add_row(
    # increase Marshallese visits counts by 2 orders of magnitude for easy comparison
    # TODO: REVERT REVERT REVERT
    visits = curr_marsh_visits[1, 1] * 100,
    race = "Marshallese",
    Date = make_date(year=year(curr_date), month=month(curr_date), day=1)
  )
  
  # filter for/add visits by NHWs
  curr_nhwht_visits = curr_pc_visits %>% filter(
    Race == "White"
  ) %>% count()
  
  pc_trends = pc_trends %>% add_row(
    visits = curr_nhwht_visits[1, 1],
    race = "Non-Hispanic White",
    Date = make_date(year=year(curr_date), month=month(curr_date), day=1)
  )
  
  # increment date by 1 month
  curr_date = curr_date + months(1)
}

# plot
ggplot(pc_trends, aes(x=Date, y=visits, color=race, group=race)) +
  geom_line() +
  geom_point() + 
  labs(
    title="Primary Care Visits by Race",
    x="Date",
    y="Number of Visits",
    color="Race"
  )
```

