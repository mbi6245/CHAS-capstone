---
title: "Objective 1 Longitudinal Analysis"
author: "Gabby Lopez"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(nlme)
library(lme4)
library(gtsummary)
library(gt)
library(lmerTest)
```
note to self: run regression diagnostics and ignore clustering - regular linear regression and see if any observations are having huge impact
change days to months

use predict() 

```{r}
bp <- read.csv('Analysis Data/Obj1BP_LME.csv')[,-1]
```

```{r cars}
# standardizing time as days from baseline measurement
bp.first <- bp %>% group_by(UniqueIdentifier) %>% arrange(BPDate, .by_group=TRUE) %>% slice_head()
bp.first$BPDate <- bp.first$KOH.start.dt
bp <- bp %>% filter(BPDate>KOH.start.dt)

bp <- rbind(bp.first, bp) %>% arrange(UniqueIdentifier, BPDate)
bp <- bp %>% mutate(time.from.koh1 = round(as.numeric(difftime(BPDate, KOH.start.dt, units="days"))))
bp <- bp %>% mutate(koh.cat = case_when(KOH.none == 1 ~ 'None',
                                        KOH.one == 1 ~ 'One',
                                        KOH.mult == 1 ~ 'Multiple'))
bp$koh.cat <- factor(bp$koh.cat, levels=c("None","One","Multiple"))
bp$male <- ifelse(bp$Sex == 'M', 1, 0)
bp$month.exact <- bp$time.from.koh1 / 30.4
bp <- bp %>% mutate(month.from.koh1 = case_when(month.exact == 0 ~ 0,
                                                month.exact > 0 & month.exact <= 1 ~ 1,
                                                month.exact > 1 & month.exact <= 2 ~ 2,
                                                month.exact > 2 & month.exact <= 3 ~ 3,
                                                month.exact > 3 & month.exact <= 4 ~ 4,
                                                month.exact > 4 & month.exact <= 5 ~ 5,
                                                month.exact > 5 & month.exact <= 6 ~ 6,
                                                month.exact > 6 & month.exact <= 7 ~ 7,
                                                month.exact > 7 & month.exact <= 8 ~ 8,
                                                month.exact > 8 & month.exact <= 9 ~ 9,
                                                month.exact > 9 & month.exact <= 10 ~ 10,
                                                month.exact > 10 & month.exact <= 11 ~ 11,
                                                month.exact > 11 & time.from.koh1 <= 365 ~ 12))

bp <- bp %>% mutate(quart.from.koh1 = case_when(month.exact == 0 ~ 0,
                                                month.exact > 0 & month.exact <= 3 ~ 1,
                                                month.exact > 3 & month.exact <= 6 ~ 2,
                                                month.exact > 6 & month.exact <= 9 ~ 3,
                                                month.exact > 9 & time.from.koh1 <= 365 ~ 4))

ggplot(data= bp, 
       aes(x=month.exact, y=Systolic, group=UniqueIdentifier, colour=koh.cat))+
  geom_line() + 
  xlab("Time (months)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))

ggplot(data= bp, 
       aes(x=quart.from.koh1, y=Systolic, group=UniqueIdentifier, colour=koh.cat))+
  geom_line() +
  xlab("Time (3 months)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))

summary_bp <- bp %>% group_by(koh.cat, month.exact) %>%
  summarise(mean_bp = mean(Systolic))

ggplot(data=summary_bp, 
       aes(x=month.exact, y=mean_bp, group=koh.cat, colour=koh.cat))+ 
   geom_smooth(method=loess, se=FALSE, linewidth=0.75) + 
  xlab("Time (months)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))

summary_bp <- bp %>% group_by(koh.cat, quart.from.koh1) %>%
  summarise(mean_bp = mean(Systolic))

ggplot(data=summary_bp, 
       aes(x=quart.from.koh1, y=mean_bp, group=koh.cat, colour=koh.cat))+ 
   geom_smooth(method=loess, se=FALSE, linewidth=0.75) + 
  xlab("Time (3 months)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))
```
need to take out first bps for patients who don't have measurements within 1 year
taking out patients that don't have a post measurement within 1 year removes 7 patients: 6 none and 1 multiple. now there are 120 analyzable patients
by month: time x one: -1.454600 (-4.099031972, 1.18983194) (p=0.28); time x multiple: -1.522243e-01 (-0.890892985, 0.58644440) (p=0.69)
              one:    3.435800 (-7.151229929, 14.02282938) (p=0.52); multiple: -4.486162e-01 (-8.418703371, 7.52147091) (p=0.91)
              time: 2.088203e-02 (-0.276850660, 0.31861473) (p=0.89)
              
For 1 year: time x one: -17.4552 (-49.14114, 14.23074); time x multiple: -1.826692 (-10.67752, 7.024135)
              one:    41.2296 (-84.52514, 166.9843); multiple: -5.383395 (-100.0536, 89.2868)
              time: 0.2505844 (-3.316888, 3.818057)
```{r}
bp.mod1 <- lme(
  fixed = Systolic ~ month.exact * koh.cat + age + male + IncomeLevel + BLACERISK + avg.bmi,
  random = ~ month.exact | UniqueIdentifier,
  data = bp,
  method = "REML"
)
summary(bp.mod1)
intervals(bp.mod1)

fixed_effects <- summary(bp.mod1)$tTable

# Get estimate and SE for month.from.koh1
month_effect <- fixed_effects["month.exact", "Value"]
month_se <- fixed_effects["month.exact", "Std.Error"]

# Compute 12-month estimate and 95% CI
estimate_12m <- 12 * month_effect
se_12m <- 12 * month_se
ci_lower <- estimate_12m - 1.96 * se_12m
ci_upper <- estimate_12m + 1.96 * se_12m

# Display results
cat("12-month estimate:", estimate_12m, "\n")
cat("95% CI: (", ci_lower, ",", ci_upper, ")\n")

month_effect <- fixed_effects["koh.catOne", "Value"]
month_se <- fixed_effects["koh.catOne", "Std.Error"]

month_effect <- fixed_effects["koh.catMultiple", "Value"]
month_se <- fixed_effects["koh.catMultiple", "Std.Error"]

month_effect <- fixed_effects["month.exact:koh.catOne", "Value"]
month_se <- fixed_effects["month.exact:koh.catOne", "Std.Error"]

month_effect <- fixed_effects["month.exact:koh.catMultiple", "Value"]
month_se <- fixed_effects["month.exact:koh.catMultiple", "Std.Error"]
```

```{r}
a1c <- read.csv('Analysis Data/Obj1A1c_LME.csv')[,-1]
```

removed 21 none, 1 one, and 2 multiple. now there are 197 analyzable patients
```{r cars}
# standardizing time as days from baseline measurement
a1c.first <- a1c %>% group_by(UniqueIdentifier) %>% arrange(A1cDate, .by_group=TRUE) %>% slice_head()
a1c.first$A1cDate <- a1c.first$KOH.start.dt
a1c <- a1c %>% filter(A1cDate>KOH.start.dt)

a1c <- rbind(a1c.first, a1c) %>% arrange(UniqueIdentifier, A1cDate)
a1c <- a1c %>% mutate(time.from.koh1 = round(as.numeric(difftime(A1cDate, KOH.start.dt, units="days"))))
a1c <- a1c %>% mutate(koh.cat = case_when(KOH.none == 1 ~ 'None',
                                        KOH.one == 1 ~ 'One',
                                        KOH.mult == 1 ~ 'Multiple'))
a1c$koh.cat <- factor(a1c$koh.cat, levels=c("None","One","Multiple"))
a1c$male <- ifelse(a1c$Sex == 'M', 1, 0)
a1c$month.exact <- a1c$time.from.koh1 / 30.4
a1c <- a1c %>% mutate(month.from.koh1 = case_when(month.exact == 0 ~ 0,
                                                month.exact > 0 & month.exact <= 1 ~ 1,
                                                month.exact > 1 & month.exact <= 2 ~ 2,
                                                month.exact > 2 & month.exact <= 3 ~ 3,
                                                month.exact > 3 & month.exact <= 4 ~ 4,
                                                month.exact > 4 & month.exact <= 5 ~ 5,
                                                month.exact > 5 & month.exact <= 6 ~ 6,
                                                month.exact > 6 & month.exact <= 7 ~ 7,
                                                month.exact > 7 & month.exact <= 8 ~ 8,
                                                month.exact > 8 & month.exact <= 9 ~ 9,
                                                month.exact > 9 & month.exact <= 10 ~ 10,
                                                month.exact > 10 & month.exact <= 11 ~ 11,
                                                month.exact > 11 & time.from.koh1 <= 365 ~ 12))

a1c <- a1c %>% mutate(quart.from.koh1 = case_when(month.exact == 0 ~ 0,
                                                month.exact > 0 & month.exact <= 3 ~ 1,
                                                month.exact > 3 & month.exact <= 6 ~ 2,
                                                month.exact > 6 & month.exact <= 9 ~ 3,
                                                month.exact > 9 & time.from.koh1 <= 365 ~ 4))

ggplot(data= a1c, 
       aes(x=month.exact, y=A1c, group=UniqueIdentifier, colour=koh.cat))+
  geom_line() + 
  xlab("Time (months)") + ylab("A1c") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))

summary_a1c <- a1c %>% group_by(koh.cat, month.exact) %>%
  summarise(mean_a1c = mean(A1c))
ggplot(data=summary_a1c, 
       aes(x=month.exact, y=mean_a1c, group=koh.cat, colour=koh.cat))+
   geom_smooth(method=loess, se=FALSE, linewidth=0.75) + 
  xlab("Time (months)") + ylab("A1c (%)") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))

summary_a1c <- a1c %>% group_by(koh.cat, quart.from.koh1) %>%
  summarise(mean_a1c = mean(A1c))

ggplot(data=summary_a1c, 
       aes(x=quart.from.koh1, y=mean_a1c, group=koh.cat, colour=koh.cat))+
   geom_smooth(method=loess, se=FALSE, linewidth=0.75) + 
  xlab("Time (3 months)") + ylab("A1c (%)") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))

```

by month: time x one: 	-0.029212306 (-0.117410544,  0.05898593) (p=0.52); time x multiple: 0.001640482 (-0.055499298, 0.05878026) (p=0.96)
              one:    0.238072755 (-0.739613363, 1.21575887) (p=0.63); multiple: -0.404180758 (-1.270355737, 0.46199422) (p=0.36)
              time: -0.010966125 (-0.034346142, 0.01241389) (p=0.36)
              
For 1 year: time x one: 	-0.3505477 (-1.406929, 0.7058333); time x multiple: 0.01968579 (-0.6646972, 0.7040688)
              one:    2.856873 (-8.808914, 14.52266); multiple: -4.850169 (-15.1854, 5.485063)
              time: -0.1315935 (-0.4116241, 0.1484371)
```{r}
a1c.mod1 <- lme(
  fixed = A1c ~ month.exact * koh.cat + age + male + IncomeLevel + BLACERISK + avg.bmi,
  random = ~ month.exact | UniqueIdentifier,
  data = a1c,
  method = "REML"
)

a1c.mod1.2 <- lmerTest::lmer(
  A1c ~ month.exact * koh.cat + age + male + IncomeLevel + BLACERISK + avg.bmi + (month.exact | UniqueIdentifier),
  data = a1c
)
summary(a1c.mod1.2)

tbl_regression(a1c.mod1.2, label=list(
  month.exact ~ 'Time from First KOH Meeting (months)',
  koh.cat ~ 'KOH Meetings Attended',
  age ~ 'Age (years)',
  male ~ 'Male Sex',
  IncomeLevel ~ 'Income Level',
  BLACERISK ~ 'Risk Score',
  avg.bmi ~ 'BMI',
  'month.exact:koh.cat' ~ 'Time * KOH Meetings Attended'
))

intervals(a1c.mod1)
summary(a1c.mod1)

fixed_effects <- summary(a1c.mod1)$tTable

# Get estimate and SE for month.from.koh1
month_effect <- fixed_effects["month.exact", "Value"]
month_se <- fixed_effects["month.exact", "Std.Error"]

# Compute 12-month estimate and 95% CI
estimate_12m <- 12 * month_effect
se_12m <- 12 * month_se
ci_lower <- estimate_12m - 1.96 * se_12m
ci_upper <- estimate_12m + 1.96 * se_12m

# Display results
cat("12-month estimate:", estimate_12m, "\n")
cat("95% CI: (", ci_lower, ",", ci_upper, ")\n")

month_effect <- fixed_effects["koh.catOne", "Value"]
month_se <- fixed_effects["koh.catOne", "Std.Error"]

month_effect <- fixed_effects["koh.catMultiple", "Value"]
month_se <- fixed_effects["koh.catMultiple", "Std.Error"]

month_effect <- fixed_effects["month.exact:koh.catOne", "Value"]
month_se <- fixed_effects["month.exact:koh.catOne", "Std.Error"]

month_effect <- fixed_effects["month.exact:koh.catMultiple", "Value"]
month_se <- fixed_effects["month.exact:koh.catMultiple", "Std.Error"]

```



secondary objective

```{r}
bp2 <- read.csv('Analysis Data/Obj2BP_LME.csv')[,-1]

bp2$KOHDate <- as.Date('2023-04-05')
bp2$Date <- as.Date(bp2$Date)
bp2.first <- bp2 %>% group_by(UniqueIdentifier) %>% arrange(Date, .by_group=TRUE) %>% slice_head()
bp2.first$Date <- bp2.first$KOHDate
bp2 <- bp2 %>% filter(Date>KOHDate)

bp2 <- rbind(bp2.first, bp2) %>% arrange(UniqueIdentifier, Date)
bp2 <- bp2 %>% mutate(time = round(as.numeric(difftime(Date, KOHDate, units="days"))))

bp2$male <- ifelse(bp2$Sex == 'M', 1, 0)
bp2$Marsh <- factor(bp2$Marsh)

bp2$month.exact <- bp2$time / 30.4

ggplot(data= bp2, 
       aes(x=month.exact, y=Systolic, group=UniqueIdentifier, colour=Marsh))+
  geom_line() + 
  xlab("Time (months)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() + 
  scale_color_discrete(name = "Race", labels=c("Non-Hispanic White", "Marshallese"))

summary_bp2 <- bp2 %>% group_by(Marsh, month.exact) %>%
  summarise(mean_bp = mean(Systolic))

ggplot(data=summary_bp2, 
       aes(x=month.exact, y=mean_bp, group=Marsh, colour=Marsh))+
  geom_smooth(method=loess, se=FALSE) + 
  xlab("Time (months)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() +
  scale_color_discrete(name = "Race", labels=c("Non-Hispanic White", "Marshallese"))
```
by month: time x marsh: -2.620347e-03 (-1.694359e-01, 1.641952e-01) (p=0.98); marsh: 1.162342 (-1.241135, 3.565818) (p=0.34);
              time: -4.964502e-02 (-7.666779e-02, -2.262224e-02) (p=0.0003)

For 1 year: time x marsh: -0.03144417 (-2.033199, 1.970311); marsh: 13.9481 (-14.8869, 42.7831);
              time: -0.5957402 (-0.9200083, -0.2714721)
```{r}
bp.mod2 <- lme(
  fixed = Systolic ~ month.exact * Marsh + age + male + IncomeLevel + avg.bmi,
  random = ~ month.exact | UniqueIdentifier,
  data = bp2,
  method = "REML"
)
summary(bp.mod2)
intervals(bp.mod2)

fixed_effects <- summary(bp.mod2)$tTable

# Get estimate and SE for month.from.koh1
month_effect <- fixed_effects["month.exact", "Value"]
month_se <- fixed_effects["month.exact", "Std.Error"]

# Compute 12-month estimate and 95% CI
estimate_12m <- 12 * month_effect
se_12m <- 12 * month_se
ci_lower <- estimate_12m - 1.96 * se_12m
ci_upper <- estimate_12m + 1.96 * se_12m

# Display results
cat("12-month estimate:", estimate_12m, "\n")
cat("95% CI: (", ci_lower, ",", ci_upper, ")\n")

month_effect <- fixed_effects["Marsh1", "Value"]
month_se <- fixed_effects["Marsh1", "Std.Error"]

month_effect <- fixed_effects["month.exact:Marsh1", "Value"]
month_se <- fixed_effects["month.exact:Marsh1", "Std.Error"]

```

objective 2 A1c
```{r}
a1c2 <- read.csv('Analysis Data/Obj2A1c_LME.csv')[,-1]

a1c2$KOHDate <- as.Date('2023-04-05')
a1c2$Date <- as.Date(a1c2$Date)
a1c2.first <- a1c2 %>% group_by(UniqueIdentifier) %>% arrange(Date, .by_group=TRUE) %>% slice_head()
a1c2.first$Date <- a1c2.first$KOHDate
a1c2 <- a1c2 %>% filter(Date>KOHDate)

a1c2 <- rbind(a1c2.first, a1c2) %>% arrange(UniqueIdentifier, Date)
a1c2 <- a1c2 %>% mutate(time = round(as.numeric(difftime(Date, KOHDate, units="days"))))

a1c2$male <- ifelse(a1c2$Sex == 'M', 1, 0)
a1c2$Marsh <- factor(a1c2$Marsh)
a1c2$month.exact <- a1c2$time / 30.4

ggplot(data= a1c2, 
       aes(x=month.exact, y=A1c, group=UniqueIdentifier, colour=Marsh))+
  geom_line() +
  xlab("Time (months)") + ylab("A1c") + theme_bw() + 
  scale_color_discrete(name = "Race", labels=c("Non-Hispanic White", "Marshallese"))

summary_a1c2 <- a1c2 %>% group_by(Marsh, month.exact) %>%
  summarise(mean_a1c = mean(A1c))

ggplot(data=summary_a1c2, 
       aes(x=month.exact, y=mean_a1c, group=Marsh, colour=Marsh))+
  geom_smooth(method=loess, se=FALSE) +
  xlab("Time (months)") + ylab("A1c (%)") + theme_bw() + 
  scale_color_discrete(name = "Race", labels=c("Non-Hispanic White", "Marshallese"))
```
by month: time x marsh: -1.081642e-02 (-0.024975889, 3.343046e-03) (p=0.13); marsh: 2.240465 (1.988022603, 2.492907) (p=0.000);
              time: 1.109435e-03 (-0.002975881, 5.194750e-03) (p=0.59)

For 1 year: time x marsh: -0.1297971 (-0.2996862, 0.04009212); marsh: 26.88558 (23.85765, 29.9135);
              time: 0.01331322 (-0.03570352, 0.06232995)
```{r}
a1c.mod2 <- lme(
  fixed = A1c ~ month.exact * Marsh + age + male + IncomeLevel + avg.bmi,
  random = ~ month.exact | UniqueIdentifier,
  data = a1c2,
  method = "REML"
)
summary(a1c.mod2)
intervals(a1c.mod2)

fixed_effects <- summary(a1c.mod2)$tTable

# Get estimate and SE for month.from.koh1
month_effect <- fixed_effects["month.exact", "Value"]
month_se <- fixed_effects["month.exact", "Std.Error"]

# Compute 12-month estimate and 95% CI
estimate_12m <- 12 * month_effect
se_12m <- 12 * month_se
ci_lower <- estimate_12m - 1.96 * se_12m
ci_upper <- estimate_12m + 1.96 * se_12m

# Display results
cat("12-month estimate:", estimate_12m, "\n")
cat("95% CI: (", ci_lower, ",", ci_upper, ")\n")

month_effect <- fixed_effects["Marsh1", "Value"]
month_se <- fixed_effects["Marsh1", "Std.Error"]

month_effect <- fixed_effects["month.exact:Marsh1", "Value"]
month_se <- fixed_effects["month.exact:Marsh1", "Std.Error"]
```

