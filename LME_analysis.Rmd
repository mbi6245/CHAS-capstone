---
title: "Objective 1 Longitudinal Analysis"
author: "Gabby Lopez"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(nlme)
```
note to self: run regression diagnostics and ignore clustering - regular linear regression and see if any observations are having huge impact
change days to months
truncate analysis after 1 year

```{r}
bp <- read.csv('Analysis Data/Obj1BP_LME.csv')[,-1]
```

```{r cars}
# standardizing time as days from baseline measurement
bp.first <- bp %>% group_by(UniqueIdentifier) %>% arrange(BPDate, .by_group=TRUE) %>% slice_head()
bp.first$BPDate <- bp.first$KOH.start.dt
bp <- bp %>% filter(BPDate>KOH.start.dt)

bp <- rbind(bp.first, bp) %>% arrange(UniqueIdentifier, BPDate)
bp <- bp %>% mutate(time.from.koh1 = round(as.numeric(difftime(BPDate, KOH.start.dt, units="days"))))
bp <- bp %>% mutate(koh.cat = case_when(KOH.none == 1 ~ 'None',
                                        KOH.one == 1 ~ 'One',
                                        KOH.mult == 1 ~ 'Multiple'))
bp$koh.cat <- factor(bp$koh.cat, levels=c("None","One","Multiple"))
bp$male <- ifelse(bp$Sex == 'M', 1, 0)
bp$month.exact <- bp$time.from.koh1 / 30.4
bp <- bp %>% mutate(month.from.koh1 = case_when(month.exact == 0 ~ 0,
                                                month.exact > 0 & month.exact <= 1 ~ 1,
                                                month.exact > 1 & month.exact <= 2 ~ 2,
                                                month.exact > 2 & month.exact <= 3 ~ 3,
                                                month.exact > 3 & month.exact <= 4 ~ 4,
                                                month.exact > 4 & month.exact <= 5 ~ 5,
                                                month.exact > 5 & month.exact <= 6 ~ 6,
                                                month.exact > 6 & month.exact <= 7 ~ 7,
                                                month.exact > 7 & month.exact <= 8 ~ 8,
                                                month.exact > 8 & month.exact <= 9 ~ 9,
                                                month.exact > 9 & month.exact <= 10 ~ 10,
                                                month.exact > 10 & month.exact <= 11 ~ 11,
                                                month.exact > 11 & month.exact <= 12 ~ 12,
                                                month.exact > 12 & month.exact <= 13 ~ 13,
                                                month.exact > 13 & month.exact <= 14 ~ 14,
                                                month.exact > 14 & month.exact <= 15 ~ 15,
                                                month.exact > 15 & month.exact <= 16 ~ 16,
                                                month.exact > 16 & month.exact <= 17 ~ 17,
                                                month.exact > 17 & month.exact <= 18 ~ 18,
                                                month.exact > 18 & month.exact <= 19 ~ 19,
                                                month.exact > 19 & month.exact <= 20 ~ 20,
                                                month.exact > 20 & month.exact <= 21 ~ 21,
                                                month.exact > 21 & month.exact <= 22 ~ 22))

bp.1yr <- bp %>% filter(month.from.koh1 <= 12)
bp.1yr.counts <- bp.1yr %>% group_by(UniqueIdentifier) %>% count(name = "freq")
bp.1yr <- full_join(bp.1yr, bp.1yr.counts, by="UniqueIdentifier")
bp.1yr <- bp.1yr %>% filter(freq > 1)
length(unique(bp.1yr$UniqueIdentifier))
bp.1yr.pts <- bp.1yr %>% distinct(UniqueIdentifier)
a1c.1yr.pts <- a1c.1yr %>% distinct(UniqueIdentifier)
obj1.1yr.pts <- rbind(bp.1yr.pts, a1c.1yr.pts)
obj1.1yr.pts <- obj1.1yr.pts %>% distinct(UniqueIdentifier)
#write.csv(obj1.1yr.pts, 'Analysis Data/Obj1_1yr_Pts.csv')

ggplot(data= bp.1yr, 
       aes(x=month.from.koh1, y=Systolic, group=UniqueIdentifier, colour=koh.cat))+
  geom_line() +
  xlab("Time (days)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))

summary_bp <- bp.1yr %>% group_by(koh.cat, month.from.koh1) %>%
  summarise(mean_bp = mean(Systolic))

ggplot(data=summary_bp, 
       aes(x=month.from.koh1, y=mean_bp, group=koh.cat, colour=koh.cat))+ 
   geom_smooth(method=loess, se=FALSE, linewidth=0.75) + 
  xlab("Time (months)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))
```
need to take out first bps for patients who don't have measurements within 1 year
taking out patients that don't have a post measurement within 1 year removes 7 patients: 6 none and 1 multiple. now there are 120 analyzable patients
```{r}
bp.mod1 <- lme(
  fixed = Systolic ~ month.from.koh1 * koh.cat + age + male + IncomeLevel + BLACERISK + avg.bmi,
  random = ~ month.from.koh1 | UniqueIdentifier,
  data = bp.1yr,
  method = "REML"
)
summary(bp.mod1)
intervals(bp.mod1, which="fixed")
-3.78554514 * 12
-0.5294044 * 12
0.38580704 * 12
```

```{r}
a1c <- read.csv('Analysis Data/Obj1A1c_LME.csv')[,-1]
```

removed 21 none, 1 one, and 2 multiple. now there are 197 analyzable patients
```{r cars}
# standardizing time as days from baseline measurement
a1c.first <- a1c %>% group_by(UniqueIdentifier) %>% arrange(A1cDate, .by_group=TRUE) %>% slice_head()
a1c.first$A1cDate <- a1c.first$KOH.start.dt
a1c <- a1c %>% filter(A1cDate>KOH.start.dt)

a1c <- rbind(a1c.first, a1c) %>% arrange(UniqueIdentifier, A1cDate)
a1c <- a1c %>% mutate(time.from.koh1 = round(as.numeric(difftime(A1cDate, KOH.start.dt, units="days"))))
a1c <- a1c %>% mutate(koh.cat = case_when(KOH.none == 1 ~ 'None',
                                        KOH.one == 1 ~ 'One',
                                        KOH.mult == 1 ~ 'Multiple'))
a1c$koh.cat <- factor(a1c$koh.cat, levels=c("None","One","Multiple"))
a1c$male <- ifelse(a1c$Sex == 'M', 1, 0)
a1c$month.exact <- a1c$time.from.koh1 / 30.4
a1c <- a1c %>% mutate(month.from.koh1 = case_when(month.exact == 0 ~ 0,
                                                month.exact > 0 & month.exact <= 1 ~ 1,
                                                month.exact > 1 & month.exact <= 2 ~ 2,
                                                month.exact > 2 & month.exact <= 3 ~ 3,
                                                month.exact > 3 & month.exact <= 4 ~ 4,
                                                month.exact > 4 & month.exact <= 5 ~ 5,
                                                month.exact > 5 & month.exact <= 6 ~ 6,
                                                month.exact > 6 & month.exact <= 7 ~ 7,
                                                month.exact > 7 & month.exact <= 8 ~ 8,
                                                month.exact > 8 & month.exact <= 9 ~ 9,
                                                month.exact > 9 & month.exact <= 10 ~ 10,
                                                month.exact > 10 & month.exact <= 11 ~ 11,
                                                month.exact > 11 & month.exact <= 12 ~ 12,
                                                month.exact > 12 & month.exact <= 13 ~ 13,
                                                month.exact > 13 & month.exact <= 14 ~ 14,
                                                month.exact > 14 & month.exact <= 15 ~ 15,
                                                month.exact > 15 & month.exact <= 16 ~ 16,
                                                month.exact > 16 & month.exact <= 17 ~ 17,
                                                month.exact > 17 & month.exact <= 18 ~ 18,
                                                month.exact > 18 & month.exact <= 19 ~ 19,
                                                month.exact > 19 & month.exact <= 20 ~ 20,
                                                month.exact > 20 & month.exact <= 21 ~ 21,
                                                month.exact > 21 & month.exact <= 22 ~ 22))

a1c.1yr <- a1c %>% filter(month.from.koh1 <= 12)
a1c.1yr.counts <- a1c.1yr %>% group_by(UniqueIdentifier) %>% count(name = "freq")
a1c.1yr <- full_join(a1c.1yr, a1c.1yr.counts, by="UniqueIdentifier")
a1c.1yr %>% filter(freq == 1) %>% select(c(UniqueIdentifier,koh.cat))
a1c.1yr <- a1c.1yr %>% filter(freq > 1)

ggplot(data= a1c.1yr, 
       aes(x=month.from.koh1, y=A1c, group=UniqueIdentifier, colour=koh.cat))+
  geom_line() + 
  xlab("Time (days)") + ylab("A1c") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))

summary_a1c <- a1c.1yr %>% group_by(koh.cat, month.from.koh1) %>%
  summarise(mean_a1c = mean(A1c))

ggplot(data=summary_a1c, 
       aes(x=month.from.koh1, y=mean_a1c, group=koh.cat, colour=koh.cat))+
   geom_smooth(method=loess, se=FALSE, linewidth=0.75) + 
  xlab("Time (months)") + ylab("A1c (%)") + theme_bw() +
  guides(colour = guide_legend(title = "KOH Attendance"))

```


```{r}
a1c.mod1 <- lme(
  fixed = A1c ~ month.from.koh1 * koh.cat + age + male + IncomeLevel + BLACERISK + avg.bmi,
  random = ~ month.from.koh1 | UniqueIdentifier,
  data = a1c.1yr,
  method = "REML"
)
intervals(a1c.mod1)
-0.067383142 * 12
0.022017191 * 12
0.111417523 * 12
summary(a1c.mod1)
```



secondary objective

```{r}
bp2 <- read.csv('Analysis Data/Obj2BP_LME.csv')[,-1]

bp2$KOHDate <- as.Date('2023-04-05')
bp2$Date <- as.Date(bp2$Date)
bp2.first <- bp2 %>% group_by(UniqueIdentifier) %>% arrange(Date, .by_group=TRUE) %>% slice_head()
bp2.first$Date <- bp2.first$KOHDate
bp2 <- bp2 %>% filter(Date>KOHDate)

bp2 <- rbind(bp2.first, bp2) %>% arrange(UniqueIdentifier, Date)
bp2 <- bp2 %>% mutate(time = round(as.numeric(difftime(Date, KOHDate, units="days"))))

bp2$male <- ifelse(bp2$Sex == 'M', 1, 0)
bp2$Marsh <- factor(bp2$Marsh)

ggplot(data= bp2, 
       aes(x=time, y=Systolic, group=UniqueIdentifier, colour=Marsh))+
  geom_line() +
  xlab("Time (days)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() + 
  scale_color_discrete(name = "Race", labels=c("Non-Hispanic White", "Marshallese"))

summary_bp2 <- bp2 %>% group_by(Marsh, time) %>%
  summarise(mean_bp = mean(Systolic))

ggplot(data=summary_bp2, 
       aes(x=time, y=mean_bp, group=Marsh, colour=Marsh))+
  geom_smooth(method=loess, se=FALSE) + 
  xlab("Time (days)") + ylab("Systolic Blood Pressure (mmHg)") + theme_bw() +
  scale_color_discrete(name = "Race", labels=c("Non-Hispanic White", "Marshallese")) + coord_cartesian(ylim=c(108,147))
```

```{r}
bp.mod2 <- lme(
  fixed = Systolic ~ time * Marsh + age + male + IncomeLevel + avg.bmi,
  random = ~ time | UniqueIdentifier,
  data = bp2,
  method = "REML"
)
summary(bp.mod2)
intervals(bp.mod2)
-5.571021e-03 * 365
-8.387029e-05 * 365
5.403280e-03 * 365
```

objective 2 A1c
```{r}
a1c2 <- read.csv('Analysis Data/Obj2A1c_LME.csv')[,-1]

a1c2$KOHDate <- as.Date('2023-04-05')
a1c2$Date <- as.Date(a1c2$Date)
a1c2.first <- a1c2 %>% group_by(UniqueIdentifier) %>% arrange(Date, .by_group=TRUE) %>% slice_head()
a1c2.first$Date <- a1c2.first$KOHDate
a1c2 <- a1c2 %>% filter(Date>KOHDate)

a1c2 <- rbind(a1c2.first, a1c2) %>% arrange(UniqueIdentifier, Date)
a1c2 <- a1c2 %>% mutate(time = round(as.numeric(difftime(Date, KOHDate, units="days"))))

a1c2$male <- ifelse(a1c2$Sex == 'M', 1, 0)
a1c2$Marsh <- factor(a1c2$Marsh)
a1c2 %>% filter(Marsh==0) %>% distinct(UniqueIdentifier)
length(unique(a1c2$UniqueIdentifier))

ggplot(data= a1c2, 
       aes(x=time, y=A1c, group=UniqueIdentifier, colour=Marsh))+
  geom_line() +
  xlab("Time (days)") + ylab("A1c") + theme_bw() + 
  scale_color_discrete(name = "Race", labels=c("Non-Hispanic White", "Marshallese"))

summary_a1c2 <- a1c2 %>% group_by(Marsh, time) %>%
  summarise(mean_a1c = mean(A1c))

ggplot(data=summary_a1c2, 
       aes(x=time, y=mean_a1c, group=Marsh, colour=Marsh))+
  geom_smooth(method=loess, se=FALSE) +
  xlab("Time (days)") + ylab("A1c (%)") + theme_bw() + 
  scale_color_discrete(name = "Race", labels=c("Non-Hispanic White", "Marshallese"))
```

```{r}
a1c.mod2 <- lme(
  fixed = A1c ~ time * Marsh + age + male + IncomeLevel + avg.bmi,
  random = ~ time | UniqueIdentifier,
  data = a1c2,
  method = "REML"
)
summary(a1c.mod2)
intervals(a1c.mod2)
-8.215749e-04 * 365
-3.558031e-04 * 365
1.099686e-04 * 365
```

